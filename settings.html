<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  deleteUser,
  updatePassword,
  EmailAuthProvider,
  reauthenticateWithCredential
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  getDoc,
  updateDoc,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";

/* ðŸ”¥ CONFIG CORRECTA â€” MISMA QUE EN TODO EL PROYECTO */
const firebaseConfig = {
  apiKey: "AIzaSyCbhjiiQ8ej5yu6LqLPb57XwrFlubFZyvA",
  authDomain: "becomingsoft-84e72.firebaseapp.com",
  projectId: "becomingsoft-84e72",
  storageBucket: "becomingsoft-84e72.firebasestorage.app",
  messagingSenderId: "605759003962",
  appId: "1:605759003962:web:ea8603a8e97e42d2278403"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let uid = null;

/* ðŸ” MANTENER SESIÃ“N */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    location.href = "login.html";
    return;
  }

  uid = user.uid;

  const snap = await getDoc(doc(db, "users", uid));
  const d = snap.data();

  if (d?.wallText) {
    titlePhrase.value = d.wallText.title || "";
    boxPhrase.value = d.wallText.box || "";
  }

  allowAnonToggle.checked = d.allowAnonymous ?? true;
});

/* ðŸ‘ ver contraseÃ±a */
window.togglePass = () => {
  newPass.type = newPass.type === "password" ? "text" : "password";
};

/* ðŸ’¾ guardar cambios */
window.saveAll = async () => {
  const user = auth.currentUser;

  /* ðŸ” cambio de contraseÃ±a seguro */
  if (newPass.value.trim()) {
    try {
      const cred = EmailAuthProvider.credential(user.email, currentPass.value);
      await reauthenticateWithCredential(user, cred);
      await updatePassword(user, newPass.value.trim());
      alert("ContraseÃ±a actualizada ðŸŒ™");
    } catch {
      alert("ContraseÃ±a actual incorrecta o sesiÃ³n antigua.");
      return;
    }
  }

  await updateDoc(doc(db, "users", uid), {
    allowAnonymous: allowAnonToggle.checked,
    wallText: {
      title: titlePhrase.value.trim(),
      box: boxPhrase.value.trim()
    }
  });

  alert("Cambios guardados ðŸŒ¿");
};

/* ðŸ—‘ eliminar cuenta */
window.deleteAccount = async () => {
  const user = auth.currentUser;
  if (!confirm("Â¿Eliminar cuenta permanentemente?")) return;

  await deleteDoc(doc(db, "users", user.uid));
  await deleteUser(user);
  location.href = "index.html";
};

window.goBack = () => location.href = "profile.html";
</script>