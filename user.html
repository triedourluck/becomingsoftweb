<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, doc, getDoc, addDoc, collection } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyCbhjiiQ8ej5yu6LqLPb57XwrFlubFZyvA",
  authDomain:"becomingsoft-84e72.firebaseapp.com",
  projectId:"becomingsoft-84e72",
  storageBucket:"becomingsoft-84e72.firebasestorage.app",
  messagingSenderId:"605759003962",
  appId:"1:605759003962:web:ea8603a8e97e42d2278403"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const params = new URLSearchParams(location.search);
const aliasParam = params.get("alias");

if(!aliasParam){
  alert("No llegÃ³ alias en la URL");
  throw new Error("alias missing");
}

const avatar = document.getElementById("avatar");
const aliasEl = document.getElementById("alias");
const stats = document.getElementById("stats");
const photos = document.getElementById("photos");
const spotify = document.getElementById("spotify");
const titleText = document.getElementById("titleText");
const msgInput = document.getElementById("msgInput");

let viewedUid = null;

async function loadUser(){

  // ðŸ”Ž 1. buscar alias
  const aliasSnap = await getDoc(doc(db,"aliases",aliasParam));

  if(!aliasSnap.exists()){
    alert("Alias no existe en Firestore");
    throw new Error("alias not found");
  }

  viewedUid = aliasSnap.data().uid;

  if(!viewedUid){
    alert("Alias sin UID");
    throw new Error("uid missing");
  }

  // ðŸ”Ž 2. buscar usuario real
  const userSnap = await getDoc(doc(db,"users",viewedUid));

  if(!userSnap.exists()){
    alert("Usuario no existe");
    throw new Error("user not found");
  }

  const d = userSnap.data();

  // ðŸ§© render
  aliasEl.textContent = d.alias || "...";
  stats.textContent = `${d.followers?.length||0} followers Â· ${d.following?.length||0} following`;

  if(d.photoURL) avatar.src = d.photoURL;

  photos.innerHTML = "";
  (d.photos||[]).forEach(url=>{
    if(!url) return;
    const img = document.createElement("img");
    img.src = url;
    img.className = "photo";
    photos.appendChild(img);
  });

  if(d.spotifyEmbed) spotify.innerHTML = d.spotifyEmbed;

  if(d.wallText){
    titleText.textContent = d.wallText.title || "EnvÃ­ame un mensaje";
    msgInput.placeholder = d.wallText.box || "Escribe algo suave...";
  }
}

window.sendMessage = async () => {
  const text = msgInput.value.trim();
  if(!text) return;

  const mode = document.querySelector('input[name="mode"]:checked').value;
  const user = auth.currentUser;

  await addDoc(collection(db,"messages"),{
    text,
    to:viewedUid,
    fromAlias: mode==="alias" && user ? user.uid : null,
    createdAt: Date.now(),
    published:false
  });

  msgInput.value="";
  alert("enviado ðŸŒ·");
};

loadUser();
</script>