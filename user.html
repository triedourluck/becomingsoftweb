<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>becomingsoft â€” user</title>

  <style>
    body { margin:0; font-family:Arial, Helvetica, sans-serif; background:#f5f5f5; color:#111; }

    .container { 
      max-width:900px; 
      margin:40px auto; 
      background:white; 
      border-radius:20px; 
      padding:32px; 
      box-shadow:0 10px 30px rgba(0,0,0,0.08);
      position:relative;
    }

    /* BUSCADOR */
    .search {
      position:absolute;
      top:20px;
      right:24px;
      display:flex;
      gap:8px;
    }

    .search input { 
      width:160px;
      padding:8px 10px; 
      border-radius:10px; 
      border:1px solid #ddd; 
    }

    .search button { 
      padding:8px 12px; 
      border:none; 
      border-radius:10px; 
      background:#111; 
      color:white; 
      cursor:pointer; 
    }

    .top { display:flex; gap:20px; align-items:center; margin-top:10px; }
    .avatar { width:80px; height:80px; border-radius:50%; background:#ddd; object-fit:cover; }
    .alias { font-size:20px; font-weight:600; }

    .stats { font-size:13px; color:#666; margin-top:4px; }

    .actions { margin-top:10px; display:flex; gap:10px; }

    .btn {
      padding:10px 16px;
      border:none;
      border-radius:12px;
      background:#111;
      color:white;
      cursor:pointer;
      font-size:14px;
    }

    .layout { display:grid; grid-template-columns:1fr 1fr; gap:24px; margin-top:24px; align-items:start; }

    .photos { 
      display:grid; 
      grid-template-columns:repeat(2,1fr); 
      gap:12px;
    }

    .photo { width:100%; height:140px; background:#eee; border-radius:12px; object-fit:cover; }

    .right { display:flex; flex-direction:column; gap:20px; }

    textarea { width:100%; height:120px; border-radius:12px; border:1px solid #ddd; padding:10px; }

    /* ðŸ“± MOBILE FIX */
    @media (max-width:700px) {

      .container { margin:0; border-radius:0; }

      .layout { grid-template-columns:1fr; }

      .top { align-items:flex-start; }

      .actions {
        flex-direction:row;
        gap:8px;
        margin-top:8px;
      }

      textarea {
        width:92%;
        margin:0 auto;
        display:block;
      }

      .send-options {
        width:92%;
        margin:10px auto 0;
        display:flex;
        justify-content:space-between;
        align-items:center;
        gap:10px;
      }

      .send-btn {
        padding:8px 14px;
        border:none;
        border-radius:10px;
        background:#111;
        color:white;
        cursor:pointer;
        font-size:13px;
      }
    }
  </style>
</head>
<body>

  <div class="container">

    <!-- BUSCADOR -->
    <div class="search">
      <input id="searchInput" placeholder="buscar usuario" />
      <button onclick="searchUser()">ir</button>
    </div>

    <!-- PERFIL -->
    <div class="top">
      <img id="avatar" class="avatar" />

      <div>
        <div class="alias" id="alias">...</div>
        <div class="stats" id="stats">0 followers Â· 0 following</div>

        <!-- BOTONES (FOLLOW + SHHH!) -->
        <div class="actions">
          <button id="followBtn" class="btn">Follow</button>
          <button id="wallBtn" class="btn">SHHH!</button>
        </div>
      </div>
    </div>

    <div class="layout">

      <!-- FOTOS -->
      <div class="photos" id="photos"></div>

      <!-- MENSAJE -->
      <div class="right">
        <div>
          <h3 id="title">EnvÃ­ame un mensaje</h3>
          <textarea id="msgBox" placeholder="Escribe algo suave..."></textarea>

          <div class="send-options">
            <label><input type="radio" name="anon" value="yes" checked /> AnÃ³nimo</label>
            <label><input type="radio" name="anon" value="no" /> Con mi alias</label>
            <button class="send-btn" onclick="sendMsg()">Enviar</button>
          </div>
        </div>
      </div>

    </div>

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, addDoc, query, where, getDocs, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCbhjiiQ8ej5yu6LqLPb57XwrFlubFZyvA",
      authDomain: "becomingsoft-84e72.firebaseapp.com",
      projectId: "becomingsoft-84e72",
      storageBucket: "becomingsoft-84e72.firebasestorage.app",
      messagingSenderId: "605759003962",
      appId: "1:605759003962:web:ea8603a8e97e42d2278403"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const aliasParam = new URLSearchParams(location.search).get("alias");

    const avatarEl = document.getElementById("avatar");
    const aliasEl = document.getElementById("alias");
    const statsEl = document.getElementById("stats");
    const photosEl = document.getElementById("photos");
    const followBtn = document.getElementById("followBtn");
    const wallBtn = document.getElementById("wallBtn");
    const titleEl = document.getElementById("title");
    const msgBox = document.getElementById("msgBox");

    let viewedUid = null;

    async function loadUser() {
      const q = query(collection(db, "users"), where("alias", "==", aliasParam));
      const snap = await getDocs(q);
      if (snap.empty) return;

      const docSnap = snap.docs[0];
      viewedUid = docSnap.id;
      const d = docSnap.data();

      aliasEl.textContent = d.alias;
      statsEl.textContent = `${d.followers?.length || 0} followers Â· ${d.following?.length || 0} following`;

      if (d.photoURL) avatarEl.src = d.photoURL;

      // frases custom
      if (d.wallText) {
        if (d.wallText.title) titleEl.textContent = d.wallText.title;
        if (d.wallText.box) msgBox.placeholder = d.wallText.box;
      }

      // fotos
      (d.photos || []).forEach(url => {
        if (!url) return;
        const img = document.createElement("img");
        img.src = url;
        img.className = "photo";
        photosEl.appendChild(img);
      });

      setupFollow(d);
      wallBtn.onclick = () => location.href = `wall.html?uid=${viewedUid}`;
    }

    async function setupFollow(d) {
      const user = auth.currentUser;
      if (!user) return;

      const isFollowing = d.followers?.includes(user.uid);

      followBtn.textContent = isFollowing ? "Unfollow" : "Follow";

      followBtn.onclick = async () => {
        const ref = doc(db, "users", viewedUid);
        const myRef = doc(db, "users", user.uid);

        if (isFollowing) {
          await updateDoc(ref, { followers: arrayRemove(user.uid) });
          await updateDoc(myRef, { following: arrayRemove(viewedUid) });
        } else {
          await updateDoc(ref, { followers: arrayUnion(user.uid) });
          await updateDoc(myRef, { following: arrayUnion(viewedUid) });
        }

        location.reload();
      };
    }

    window.sendMsg = async () => {
      const text = msgBox.value.trim();
      if (!text) return;

      const user = auth.currentUser;

      const isAnon = document.querySelector('input[name="anon"]:checked').value === "yes";

      await addDoc(collection(db, "messages"), {
        text,
        to: viewedUid,
        from: isAnon ? null : user?.uid || null,
        createdAt: new Date(),
        published: false
      });

      msgBox.value = "";
      alert("Mensaje enviado ðŸŒ¿");
    };

    window.searchUser = () => {
      const a = document.getElementById("searchInput").value.trim();
      if (!a) return;
      location.href = `user.html?alias=${a}`;
    };

    loadUser();
  </script>
</body>
</html>
