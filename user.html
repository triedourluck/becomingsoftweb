<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>becomingsoft â€” user</title>

<style>
/* TODO TU CSS EXACTAMENTE IGUAL */
</style>
</head>

<body>

<!-- TODO TU HTML EXACTAMENTE IGUAL -->

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  where,
  getDocs,
  doc,
  getDoc,
  arrayUnion,
  arrayRemove,
  addDoc,
  runTransaction,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyCbhjiiQ8ej5yu6LqLPb57XwrFlubFZyvA",
  authDomain:"becomingsoft-84e72.firebaseapp.com",
  projectId:"becomingsoft-84e72",
  storageBucket:"becomingsoft-84e72.firebasestorage.app",
  messagingSenderId:"605759003962",
  appId:"1:605759003962:web:ea8603a8e97e42d2278403"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const params = new URLSearchParams(location.search);
const aliasParam = params.get("alias");

const avatar = document.getElementById("avatar");
const aliasEl = document.getElementById("alias");
const photos = document.getElementById("photos");
const spotifyContainer = document.getElementById("spotify");
const followBtn = document.getElementById("followBtn");
const shhhBtn = document.getElementById("shhhBtn");
const followersLink = document.getElementById("followersLink");
const followingLink = document.getElementById("followingLink");
const titleText = document.getElementById("titleText");
const msgInput = document.getElementById("msgInput");

let viewedUid = null;
let localIsFollowing = false;
let localFollowersCount = 0;

async function setupFollow(){

  const currentUser = auth.currentUser;

  if(!currentUser || currentUser.uid === viewedUid){
    followBtn.style.display = "none";
    return;
  }

  followBtn.style.display = "inline-block";

  const currentUserRef = doc(db,"users",currentUser.uid);
  const viewedUserRef = doc(db,"users",viewedUid);

  const currentSnap = await getDoc(currentUserRef);
  const viewedSnap = await getDoc(viewedUserRef);

  const currentData = currentSnap.data();
  const viewedData = viewedSnap.data();

  localIsFollowing = currentData.following?.includes(viewedUid);
  localFollowersCount = viewedData.followers?.length || 0;

  followBtn.textContent = localIsFollowing ? "Unfollow" : "Follow";

  followBtn.onclick = async () => {

    await runTransaction(db, async (transaction) => {

      const currentDoc = await transaction.get(currentUserRef);
      const viewedDoc = await transaction.get(viewedUserRef);

      const currentFollowing = currentDoc.data().following || [];

      if(currentFollowing.includes(viewedUid)){
        transaction.update(currentUserRef,{
          following: arrayRemove(viewedUid)
        });
        transaction.update(viewedUserRef,{
          followers: arrayRemove(currentUser.uid)
        });
      }else{
        transaction.update(currentUserRef,{
          following: arrayUnion(viewedUid)
        });
        transaction.update(viewedUserRef,{
          followers: arrayUnion(currentUser.uid)
        });
      }

    });

    // ðŸ”¥ ACTUALIZACIÃ“N INMEDIATA SIN RELEER FIRESTORE

    if(localIsFollowing){
      localIsFollowing = false;
      localFollowersCount--;
      followBtn.textContent = "Follow";
    }else{
      localIsFollowing = true;
      localFollowersCount++;
      followBtn.textContent = "Unfollow";
    }

    followersLink.textContent = `${localFollowersCount} followers`;

  };
}

async function loadUser(){

  if(!aliasParam) return;

  const q = query(collection(db,"users"), where("alias","==",aliasParam));
  const snap = await getDocs(q);

  if(snap.empty){
    alert("Usuario no encontrado ðŸ’­");
    return;
  }

  const userDoc = snap.docs[0];
  viewedUid = userDoc.id;
  const d = userDoc.data();

  aliasEl.textContent = d.alias;
  if(d.photoURL) avatar.src = d.photoURL;

  localFollowersCount = d.followers?.length || 0;

  followersLink.textContent = `${localFollowersCount} followers`;
  followingLink.textContent = `${d.following?.length||0} following`;

  await setupFollow();
}

onAuthStateChanged(auth, async (user)=>{
  await loadUser();
});
</script>

</body>
</html>