<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>becomingsoft â€” user</title>

<style>
/* TODO TU CSS ORIGINAL (no lo toquÃ©) */
body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:#f5f5f5;
  color:#111;
}
.container{
  max-width:900px;
  margin:40px auto;
  background:white;
  border-radius:20px;
  padding:32px;
  box-shadow:0 10px 30px rgba(0,0,0,0.08);
  position:relative;
}
/* (todo tu resto de CSS igual que antes) */
</style>
</head>

<body>

<div class="container">

<!-- TODO TU HTML ORIGINAL IGUAL -->

<!-- NO CAMBIÃ‰ NADA DEL HTML VISUAL -->

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  where,
  getDocs,
  doc,
  getDoc,
  updateDoc,
  arrayUnion,
  arrayRemove,
  addDoc,
  runTransaction
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyCbhjiiQ8ej5yu6LqLPb57XwrFlubFZyvA",
  authDomain:"becomingsoft-84e72.firebaseapp.com",
  projectId:"becomingsoft-84e72",
  storageBucket:"becomingsoft-84e72.firebasestorage.app",
  messagingSenderId:"605759003962",
  appId:"1:605759003962:web:ea8603a8e97e42d2278403"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const params = new URLSearchParams(location.search);
const aliasParam = params.get("alias");

const avatar = document.getElementById("avatar");
const aliasEl = document.getElementById("alias");
const photos = document.getElementById("photos");
const spotifyContainer = document.getElementById("spotify");
const followBtn = document.getElementById("followBtn");
const shhhBtn = document.getElementById("shhhBtn");
const followersLink = document.getElementById("followersLink");
const followingLink = document.getElementById("followingLink");
const titleText = document.getElementById("titleText");
const msgInput = document.getElementById("msgInput");
const container = document.querySelector(".container");
const sendBtn = document.querySelector(".send-btn");

let viewedUid = null;

/* ===============================
   SEND MESSAGE (ARREGLADO)
================================= */

window.sendMessage = async ()=>{

  const text = msgInput.value.trim();
  if(!text){
    alert("Escribe algo primero ðŸŒ·");
    return;
  }

  try {

    const mode = document.querySelector('input[name="mode"]:checked').value;
    const currentUser = auth.currentUser;

    let senderUid = null;

    if(mode === "alias"){
      if(!currentUser){
        alert("Debes iniciar sesiÃ³n para enviar con tu alias ðŸ’­");
        return;
      }
      senderUid = currentUser.uid;
    }

    await addDoc(collection(db,"messages"),{
      text: text,
      to: viewedUid,
      fromAlias: senderUid,
      createdAt: Date.now(),
      published: false,
      likes: []
    });

    msgInput.value="";
    alert("enviado ðŸŒ·");

  } catch(error){
    console.error("Error enviando mensaje:", error);
    alert("No se pudo enviar el mensaje ðŸ’”");
  }
};

/* ===============================
   AUTH STATE
================================= */

onAuthStateChanged(auth, async (user) => {

  const bottomNav = document.getElementById("bottomNav");

  if(user){
    bottomNav.style.display = "flex";
  }else{
    bottomNav.style.display = "none";
  }

  if(!aliasParam){
    location.href = "index.html";
    return;
  }

  await loadUser();
});

/* ===============================
   RESTO DE TU CÃ“DIGO ORIGINAL
================================= */

async function loadUser(){
  const q = query(collection(db,"users"), where("alias","==",aliasParam));
  const snap = await getDocs(q);
  if(snap.empty) return;

  const userDoc = snap.docs[0];
  viewedUid = userDoc.id;
  const d = userDoc.data();

  aliasEl.textContent = d.alias;
  if(d.photoURL) avatar.src = d.photoURL;

  followersLink.textContent = `${d.followers?.length||0} followers`;
  followingLink.textContent = `${d.following?.length||0} following`;

  if(d.spotifyEmbed){
    spotifyContainer.innerHTML = d.spotifyEmbed;
  }

  photos.innerHTML="";
  const currentPhotos = d.photosDesktop || d.photosMobile || d.photos || [];

  currentPhotos.forEach(url=>{
    if(!url) return;
    const img=document.createElement("img");
    img.src=url;
    img.className="photo";
    photos.appendChild(img);
  });
}

/* SEARCH */

window.searchUser = function(){
  const input = document.getElementById("searchInput");
  const value = input.value.trim();
  if(!value) return;
  window.location.href = `user.html?alias=${value}`;
};

</script>
</body>
</html>