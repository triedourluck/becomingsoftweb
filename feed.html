<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Feed</title>

<style>
body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:#f5f5f5;
  color:#111;
}

.container{
  max-width:700px;
  margin:40px auto;
  background:white;
  border-radius:20px;
  padding:28px;
  box-shadow:0 10px 30px rgba(0,0,0,0.08);
}

.top-bar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}

.nav-buttons{
  display:flex;
  gap:8px;
}

.gear,
.icon-btn{
  padding:8px 12px;
  border:none;
  border-radius:10px;
  background:#111;
  color:white;
  cursor:pointer;
  font-size:13px;
}

.icon-btn.active{
  background:#444;
}

h1{ 
  margin:0; 
  font-size:22px; 
}

.post{
  border:1px solid #eee;
  border-radius:18px;
  padding:18px;
  margin-bottom:18px;
  background:#fafafa;
}

.user-row{
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom:8px;
  cursor:pointer;
}

.user-row:hover{ opacity:0.8; }

.avatar{
  width:40px;
  height:40px;
  border-radius:50%;
  object-fit:cover;
  background:#ddd;
}

.username{
  font-weight:600;
}

.message-box,
.reply-box{
  background:white;
  border:1px solid #eee;
  border-radius:14px;
  padding:12px;
  margin-bottom:12px;
  font-size:15px;
}

.reply-box{ color:#555; }

.like{
  margin-top:10px;
  font-size:15px;
  cursor:pointer;
  user-select:none;
}

.post-image{
  width:70%;
  border-radius:14px;
  margin-top:10px;
}

/* Mobile */
@media (max-width:768px){
  .post-image{
    width:100%;
  }
}

.comments {
  margin-top: 12px;
  padding-top: 8px;
  border-top: 1px solid #eaeaea;
}

.comment {
  font-size: 13px;
  background: #f2f2f2;
  padding: 6px 10px;
  border-radius: 14px;
  margin-bottom: 6px;
  display: inline-block;
  max-width: 85%;
}

.comment-author {
  font-weight: 600;
  margin-right: 4px;
}

.comment-text {
  font-weight: 400;
}

.comment-form {
  display: flex;
  gap: 6px;
  margin-top: 8px;
}

.comment-input {
  flex: 1;
  padding: 6px 10px;
  border-radius: 14px;
  border: 1px solid #ddd;
  font-size: 13px;
}

.comment-btn {
  padding: 6px 12px;
  border-radius: 14px;
  border: none;
  background: black;
  color: white;
  font-size: 13px;
  cursor: pointer;
}

.comment-author {
  font-weight: 600;
  text-decoration: none;
  color: black;
  margin-right: 4px;
}

.comment-author:hover {
  text-decoration: underline;
}

.comment-delete {
  font-size: 12px;
  color: #888;
  cursor: pointer;
}

.comment-delete:hover {
  color: red;
}

</style>
</head>

<body>

<div class="container">

  <div class="top-bar">
    <h1>Feed</h1>
    <div class="nav-buttons">
      <button class="gear" onclick="location.href='settings.html'">⚙️</button>
      <button class="icon-btn" id="profileBtn">Profile</button>
      <button class="icon-btn" onclick="location.href='inbox.html'">✉️</button>
      <button class="icon-btn" id="wallBtn">SHHH!</button>
    </div>
  </div>

  <div id="feed"></div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  orderBy,
  onSnapshot,
  where,
  getDocs,
  getDoc,
  doc,
  updateDoc,
  arrayUnion,
  arrayRemove,
  addDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig={
  apiKey:"AIzaSyCbhjiiQ8ej5yu6LqLPb57XwrFlubFZyvA",
  authDomain:"becomingsoft-84e72.firebaseapp.com",
  projectId:"becomingsoft-84e72",
  storageBucket:"becomingsoft-84e72.firebasestorage.app",
  messagingSenderId:"605759003962",
  appId:"1:605759003962:web:ea8603a8e97e42d2278403"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);
const feedEl=document.getElementById("feed");
const wallBtn=document.getElementById("wallBtn");
const profileBtn=document.getElementById("profileBtn");

onAuthStateChanged(auth, async(user)=>{
  if(!user){
    location.href="login.html";
    return;
  }
  
  wallBtn.onclick=()=>location.href=`wall.html?uid=${user.uid}`;
  
  profileBtn.onclick=()=>location.href="profile.html";

  feedEl.innerHTML="";

  const messagesSnap = await getDocs(
  query(
    collection(db,"messages"),
    where("published","==",true),
    orderBy("createdAt","desc")
  )
);

const statusSnap = await getDocs(query(
  collection(db,"statusPosts"),
  orderBy("createdAt","desc")
));

  const allDocs=[];
  const seenIds = new Set();

  messagesSnap.forEach(d=>{
  if(seenIds.has(d.id)) return;
  seenIds.add(d.id);

  const data = d.data();
  allDocs.push({
    id: d.id,
    ...data,
    source: "messages",
    createdAt: data.createdAt?.seconds || 0
  });
});

statusSnap.forEach(d=>{
  if(seenIds.has(d.id)) return;
  seenIds.add(d.id);

  const data = d.data();
  allDocs.push({
    id: d.id,
    ...data,
    source: "statusPosts",
    createdAt: data.createdAt?.seconds || 0
  });
});

 allDocs.sort((a,b)=> b.createdAt - a.createdAt);

  const limitedDocs = allDocs.slice(0,20);

  for(const data of limitedDocs){

    const post=document.createElement("div");
    post.className="post";

    async function getUserByUid(uid){
      const userRef=doc(db,"users",uid);
      const snap=await getDoc(userRef);
      if(snap.exists()) return {id:snap.id, ...snap.data()};
      return null;
    }

    async function getUserByAlias(alias){
      const snap=await getDocs(query(
        collection(db,"users"),
        where("alias","==",alias)
      ));
      if(!snap.empty) return {id:snap.docs[0].id, ...snap.docs[0].data()};
      return null;
    }

    let senderUser = null;

    if (data.source === "messages") {

      if (data.fromAlias) {

  // primero intentar como UID
  senderUser = await getUserByUid(data.fromAlias);

  // si no existe como UID, intentar como alias
  if (!senderUser) {
    senderUser = await getUserByAlias(data.fromAlias);
  }
}

    } else {

      if (data.authorUid) {
        senderUser = await getUserByUid(data.authorUid);
      }

      if (!senderUser && data.authorAlias) {
        senderUser = await getUserByAlias(data.authorAlias);
      }
    }

    const senderRow=document.createElement("div");
    senderRow.className="user-row";

    const senderAvatar=document.createElement("img");
    senderAvatar.className="avatar";

    const senderName=document.createElement("div");
    senderName.className="username";

    if(senderUser){
      senderAvatar.src=senderUser.photoURL || "";
      senderName.textContent=senderUser.alias;
      senderRow.onclick=()=>{
        if(user.uid===senderUser.id){
          location.href="profile.html";
        }else{
          location.href=`user.html?alias=${senderUser.alias}`;
        }
      };
    }else{
      senderAvatar.src="";
      senderName.textContent="anónimo";
      senderRow.style.cursor="default";
    }

    senderRow.appendChild(senderAvatar);
    senderRow.appendChild(senderName);
    post.appendChild(senderRow);

    if(data.text){
      const messageBox=document.createElement("div");
      messageBox.className="message-box";
      messageBox.textContent=data.text;
      post.appendChild(messageBox);
    }
    
    if(data.mediaURL){
  const img=document.createElement("img");
  img.src=data.mediaURL;
  img.className="post-image";
  post.appendChild(img);
}

    if(data.reply){

      let replyUser=null;

      if(data.source==="messages" && data.to){
        replyUser=await getUserByUid(data.to);
      }

      if(data.source==="posts" && data.authorAlias){
        replyUser=await getUserByAlias(data.authorAlias);
      }

      const replyBox=document.createElement("div");
      replyBox.className="reply-box";
      replyBox.textContent=data.reply;
      post.appendChild(replyBox);

      if(replyUser){

        const replyRow=document.createElement("div");
        replyRow.className="user-row";

        const replyAvatar=document.createElement("img");
        replyAvatar.className="avatar";
        replyAvatar.src=replyUser.photoURL || "";

        const replyName=document.createElement("div");
        replyName.className="username";
        replyName.textContent=replyUser.alias;

        replyRow.onclick=()=>{
          if(user.uid===replyUser.id){
            location.href="profile.html";
          }else{
            location.href=`user.html?alias=${replyUser.alias}`;
          }
        };

        replyRow.appendChild(replyAvatar);
        replyRow.appendChild(replyName);
        post.appendChild(replyRow);
      }
    }

if(!data.likes){
  data.likes = [];
}

const likesArray = data.likes;
const hasLiked = likesArray.includes(user.uid);

const likeDiv = document.createElement("div");
likeDiv.className = "like";
likeDiv.textContent = `${hasLiked ? "♥︎" : "♡"} ${likesArray.length}`;

    likeDiv.onclick = async () => {

  const ref = doc(db, data.source, data.id);

  const alreadyLiked = (data.likes || []).includes(user.uid);

  if(alreadyLiked){
    await updateDoc(ref,{
      likes: arrayRemove(user.uid)
    });

    data.likes = (data.likes || []).filter(id => id !== user.uid);

  } else {

    await updateDoc(ref,{
      likes: arrayUnion(user.uid)
    });

    data.likes = [...(data.likes || []), user.uid];

    const targetUserId =
      data.source === "statusPosts"
        ? data.authorUid
        : data.to;

    if(targetUserId && targetUserId !== user.uid){
      await addDoc(collection(db,"notifications"),{
        type:"like",
        fromUid:user.uid,
        toUserId: targetUserId,
        postId: data.id,
        createdAt: serverTimestamp(),
        read:false
      });
    }
  }

  likeDiv.textContent =
    `${data.likes.includes(user.uid) ? "♥︎" : "♡"} ${data.likes.length}`;
};

    post.appendChild(likeDiv);
    
    const commentsContainer = document.createElement("div");
    commentsContainer.className = "comments";
    post.appendChild(commentsContainer);
    
    // --- formulario de comentario ---
if (user) {

  const commentForm = document.createElement("div");
  commentForm.className = "comment-form";

  const commentInput = document.createElement("input");
  commentInput.type = "text";
  commentInput.placeholder = "Escribe un comentario...";
  commentInput.className = "comment-input";

  const commentBtn = document.createElement("button");
  commentBtn.textContent = "Postear";
  commentBtn.className = "comment-btn";
  
  commentBtn.onclick = async () => {

  const text = commentInput.value.trim();
  if (!text) return;
  
  const userSnap = await getDoc(doc(db, "users", user.uid));
  const userData = userSnap.data();

  await addDoc(
    collection(db, "statusPosts", data.id, "comments"),
    {
      authorUid: user.uid,
      authorAlias: userData.alias,
      text: text,
      createdAt: serverTimestamp()
    }
  );

  commentInput.value = "";
};

  commentForm.appendChild(commentInput);
  commentForm.appendChild(commentBtn);

  post.appendChild(commentForm);

}
    
    const commentsRef = collection(db, "statusPosts", data.id, "comments");
    const commentsQuery = query(commentsRef, orderBy("createdAt", "asc"));

  onSnapshot(commentsQuery, snapshot => {
  commentsContainer.innerHTML = "";

  snapshot.forEach(docSnap => {
    const comment = docSnap.data();

    const commentDiv = document.createElement("div");
    commentDiv.className = "comment";

    commentDiv.innerHTML = `
  <a href="/user.html?uid=${comment.authorUid}" class="comment-author">
    ${comment.authorAlias}
  </a>
  <span class="comment-text">${comment.text}</span>
`;

if (
  user &&
  (user.uid === comment.authorUid || user.uid === data.authorUid)
) {

  const deleteBtn = document.createElement("span");
  deleteBtn.textContent = " · eliminar";
  deleteBtn.className = "comment-delete";

  deleteBtn.onclick = async () => {
    await deleteDoc(
      doc(db, "statusPosts", data.id, "comments", docSnap.id)
    );
  };

  commentDiv.appendChild(deleteBtn);
}

    commentsContainer.appendChild(commentDiv);
  });
});

    feedEl.appendChild(post);
  }
});
</script>

</body>
</html>
