<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>becomingsoft — mi perfil</title>

<style>
/* TODO TU CSS EXACTAMENTE IGUAL — NO TOQUÉ NADA */
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#f5f5f5;color:#111;}

.container{
  max-width:900px;
  margin:40px auto;
  background:white;
  border-radius:20px;
  padding:32px;
  box-shadow:0 10px 30px rgba(0,0,0,0.08);
  position:relative;
}

/* =========================
   NOTIFICATIONS
========================= */

.notif-wrapper{
  position:absolute;
  top:20px;
  left:24px;
}

.notif-btn{
  cursor:pointer;
  position:relative;
  background:none;
  border:none;
  padding:6px;
}

.notif-dot{
  width:6px;
  height:6px;
  background:#111;
  border-radius:50%;
  position:absolute;
  top:4px;
  right:4px;
  display:none;
}

.notif-dropdown{
  position:absolute;
  top:36px;
  left:0;
  width:260px;
  background:white;
  border:1px solid #eee;
  box-shadow:0 4px 20px rgba(0,0,0,0.05);
  display:none;
  z-index:999;
}

.notif-header{
  padding:12px;
  font-size:13px;
  border-bottom:1px solid #f2f2f2;
  text-transform:lowercase;
}

.notif-item{
  padding:12px;
  font-size:13px;
  border-bottom:1px solid #f5f5f5;
  cursor:pointer;
}

.notif-item:hover{
  background:#fafafa;
}

/* RESTO DEL CSS IGUAL... */
</style>
</head>

<body>
<div class="container">

<!-- TODO TU HTML EXACTAMENTE IGUAL — NO LO TOQUÉ -->

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc, collection, query, where, orderBy, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
import { getStorage } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";

const firebaseConfig={
apiKey:"AIzaSyCbhjiiQ8ej5yu6LqLPb57XwrFlubFZyvA",
authDomain:"becomingsoft-84e72.firebaseapp.com",
projectId:"becomingsoft-84e72",
storageBucket:"becomingsoft-84e72.firebasestorage.app",
messagingSenderId:"605759003962",
appId:"1:605759003962:web:ea8603a8e97e42d2278403"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);
getStorage(app);

/* ===== FIX IMPORTANTE =====
   ESTO ERA LO QUE TE ESTABA ROMPIENDO TODO
   FALTABAN ESTAS REFERENCIAS
*/

const notifBtn=document.getElementById("notifBtn");
const notifDropdown=document.getElementById("notifDropdown");
const notifDot=document.getElementById("notifDot");
const notifList=document.getElementById("notifList");

const alias=document.getElementById("alias");
const avatar=document.getElementById("avatar");
const followersBtn=document.getElementById("followersBtn");
const followingBtn=document.getElementById("followingBtn");
const spotifyEmbed=document.getElementById("spotifyEmbed");
const logoutBtn=document.getElementById("logoutBtn");

let uid=null;

onAuthStateChanged(auth,async(user)=>{
if(!user){location.href="login.html";return;}
uid=user.uid;

/* LISTEN NOTIFICATIONS */

const q=query(
collection(db,"notifications"),
where("toUserId","==",uid),
orderBy("createdAt","desc")
);

onSnapshot(q,(snapshot)=>{
notifList.innerHTML="";
let unread=0;

snapshot.forEach(docSnap=>{
const data=docSnap.data();
if(!data.read) unread++;

const div=document.createElement("div");
div.className="notif-item";

if(data.type==="follow"){
div.textContent=`${data.fromUsername} started following you`;
}
else if(data.type==="like"){
div.textContent=`${data.fromUsername} liked your space`;
}
else if(data.type==="message"){
div.textContent=`${data.fromUsername} sent you a message`;
}
else{
div.textContent="new activity";
}

notifList.appendChild(div);
});

notifDot.style.display=unread>0?"block":"none";
});

/* LOAD PROFILE */

const snap=await getDoc(doc(db,"users",uid));
if(!snap.exists()) return;

const d=snap.data();

document.getElementById("profileLink").value=`https://becomingsoft.com/${d.alias||""}`;

alias.textContent=d.alias||"sin alias";
followersBtn.textContent=`${(d.followers||[]).length} followers`;
followingBtn.textContent=`${(d.following||[]).length} following`;

if(d.photoURL) avatar.src=d.photoURL;

const currentPhotos=(d.photosDesktop||d.photos||["","","","","",""]);
currentPhotos.forEach((url,i)=>{
if(url){
const img=document.getElementById(`p${i+1}`);
if(img) img.src=url;
}
});

if(d.spotifyEmbed) spotifyEmbed.innerHTML=d.spotifyEmbed;

});

/* MARK AS READ */

notifBtn.addEventListener("click",async(e)=>{
e.stopPropagation();

const open=notifDropdown.style.display==="block";
notifDropdown.style.display=open?"none":"block";

if(!open && uid){
const unreadQuery=query(
collection(db,"notifications"),
where("toUserId","==",uid),
where("read","==",false)
);

const snap=await getDocs(unreadQuery);
snap.forEach(docSnap=>{
updateDoc(doc(db,"notifications",docSnap.id),{read:true});
});
}
});

document.addEventListener("click",(e)=>{
if(!e.target.closest(".notif-wrapper")){
notifDropdown.style.display="none";
}
});

/* LOGOUT */

logoutBtn.addEventListener("click",async()=>{
await signOut(auth);
location.href="login.html";
});
</script>

</body>
</html>