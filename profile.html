<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>becomingsoft ‚Äî mi perfil</title>

<style>
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#f5f5f5;color:#111;}

.container{
  max-width:900px;
  margin:40px auto;
  background:white;
  border-radius:20px;
  padding:32px;
  box-shadow:0 10px 30px rgba(0,0,0,0.08);
  position:relative;
}
/* =========================
   NOTIFICATIONS
========================= */

.notif-wrapper{
  position:absolute;
  top:20px;
  left:24px;
}

.notif-btn{
  cursor:pointer;
  position:relative;
  background:none;
  border:none;
  padding:6px;
}

.notif-dot{
  width:6px;
  height:6px;
  background:#111;
  border-radius:50%;
  position:absolute;
  top:4px;
  right:4px;
  display:none;
}

.notif-dropdown{
  position:absolute;
  top:36px;
  left:0;
  width:260px;
  background:white;
  border:1px solid #eee;
  box-shadow:0 4px 20px rgba(0,0,0,0.05);
  display:none;
  z-index:999;
}

.notif-header{
  padding:12px;
  font-size:13px;
  border-bottom:1px solid #f2f2f2;
  text-transform:lowercase;
}

.notif-item{
  padding:12px;
  font-size:13px;
  border-bottom:1px solid #f5f5f5;
  cursor:pointer;
}

.notif-item:hover{
  background:#fafafa;
}
.search{position:absolute;top:20px;right:24px;display:flex;gap:8px;}
.search input{width:190px;padding:10px 12px;border-radius:12px;border:1px solid #ddd;font-size:14px;}
.search button{padding:10px 16px;border:none;border-radius:12px;background:#111;color:white;cursor:pointer;font-size:14px;}

.top-actions{
  position:absolute;
  top:64px;
  right:24px;
  display:flex;
  gap:8px;
}

.reorder-top,
.logout{
  padding:8px 14px;
  border:none;
  border-radius:10px;
  background:#111;
  color:white;
  cursor:pointer;
  font-size:13px;
}

.top{display:flex;gap:20px;align-items:center;margin-top:10px;}
.avatar{width:80px;height:80px;border-radius:50%;background:#ddd;object-fit:cover;cursor:pointer;}
.alias{font-size:20px;font-weight:600;}

.stats{font-size:13px;color:#666;margin-top:6px;}
.stats span{cursor:pointer;}

.layout{display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-top:24px;align-items:start;}

.photos{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;}
.photo{width:100%;height:140px;background:#eee;border-radius:12px;object-fit:cover;cursor:pointer;}

.right{display:flex;flex-direction:column;gap:20px;}

.spotify{margin-top:40px;width:100%;}
.spotify iframe{width:100%;border:none;border-radius:12px;display:block;}
.spotify input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #ddd;margin-top:14px;box-sizing:border-box;}

.save-btn{margin-top:8px;padding:6px 12px;border:none;border-radius:8px;background:#111;color:white;cursor:pointer;font-size:12px;}

.bottom{margin-top:24px;display:flex;gap:12px;}
.gear,.icon-btn{padding:10px 14px;border:none;border-radius:10px;background:#111;color:white;cursor:pointer;font-size:14px;}

.hidden{display:none;}

.reorder-active .photo{cursor:grab;opacity:0.85;}
.reorder-active .photo:active{cursor:grabbing;}

/* ===== SHARE CARD ===== */

.share-card{
  margin-top:20px;
}

.share-card h3{
  margin:0 0 4px 0;
  font-size:15px;
}

.share-card p{
  margin:0 0 10px 0;
  font-size:13px;
  opacity:0.7;
}

.share-link-row{
  display:flex;
  gap:10px;
  width:100%;
}

.share-link-row input{
  flex:1;
  width:100%;
  padding:14px 16px;
  border-radius:12px;
  border:1px solid #ddd;
  font-size:14px;
  box-sizing:border-box;
}

.share-link-row button{
  padding:14px 18px;
  border:none;
  border-radius:12px;
  background:#111;
  color:white;
  cursor:pointer;
  font-size:14px;
  appearance:none;
  -webkit-appearance:none;
}

.copy-message{
  display:block;
  margin-top:6px;
  font-size:12px;
}

@media (max-width:700px){
.container{margin:0;border-radius:0;padding:20px 18px 90px;}
.search{position:absolute;top:14px;right:16px;}
.search input{width:130px;padding:6px 8px;font-size:12px;}
.search button{padding:6px 10px;font-size:12px;}

.top-actions{top:54px;right:16px;}

.reorder-top,
.logout{font-size:12px;padding:6px 10px;}

.top{margin-top:80px;gap:12px;}
.avatar{width:64px;height:64px;}
.alias{font-size:18px;}
.stats{font-size:12px;margin-top:4px;}
.layout{display:block;margin-top:20px;}
.photos{grid-template-columns:repeat(3,1fr);gap:10px;}
.photo{height:100px;}
.bottom{position:fixed;bottom:18px;left:0;width:100%;justify-content:center;}

.share-card h3{font-size:14px;}
.share-card p{font-size:12px;margin-bottom:8px;}
}
</style>
</head>

<body>
<div class="container">
  
  <!-- NOTIFICATIONS -->
<div class="notif-wrapper">
  <button id="notifBtn" class="notif-btn">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
      <path d="M18 8a6 6 0 10-12 0c0 7-3 7-3 7h18s-3 0-3-7" stroke="#111" stroke-width="1.5"/>
      <path d="M13.73 21a2 2 0 01-3.46 0" stroke="#111" stroke-width="1.5"/>
    </svg>
    <span id="notifDot" class="notif-dot"></span>
  </button>

  <div id="notifDropdown" class="notif-dropdown">
    <div class="notif-header">notifications</div>
    <div id="notifList"></div>
  </div>
</div>

<div class="search">
<input id="searchInput" placeholder="buscar usuario"/>
<button id="searchBtn">ir</button>
</div>

<div class="top-actions">
  <button class="reorder-top" id="reorderBtn">Reordenar fotos</button>
  <button class="logout" id="logoutBtn">Cerrar sesi√≥n</button>
</div>

<div class="top">
<img id="avatar" class="avatar"/>
<input type="file" id="avatarInput" class="hidden" accept="image/*"/>
<div>
<div class="alias" id="alias">...</div>
<div class="stats">
<span id="followersBtn">0 followers</span> ¬∑
<span id="followingBtn">0 following</span>
</div>
</div>
</div>

<div class="layout">
<div>
<div class="photos">
<img id="p1" class="photo"/>
<img id="p2" class="photo"/>
<img id="p3" class="photo"/>
<img id="p4" class="photo"/>
<img id="p5" class="photo"/>
<img id="p6" class="photo"/>
</div>
<input type="file" id="photoInput" class="hidden" accept="image/*"/>
</div>

<div class="right">
<div class="spotify">
<div id="spotifyEmbed"></div>
<input id="spotifyInput" placeholder="Pega aqu√≠ el embed de Spotify"/>
<button class="save-btn" id="saveSpotifyBtn">Guardar playlist</button>
</div>

<div class="share-card">
  <h3>Share your space üñáÔ∏è</h3>
  <p>Copy your personal link and share it with others.</p>

  <div class="share-link-row">
    <input type="text" id="profileLink" readonly>
    <button id="copyBtn">Copy</button>
  </div>

  <span id="copyMessage" class="copy-message"></span>
</div>
</div>
</div>

<div class="bottom">
<button class="gear" onclick="location.href='settings.html'">‚öôÔ∏è</button>
<button class="icon-btn" onclick="location.href='feed.html'">Feed</button>
<button class="icon-btn" onclick="location.href='inbox.html'">‚úâÔ∏è</button>
<button class="icon-btn" id="wallBtn">SHHH!</button>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { 
  getFirestore, 
  doc, 
  getDoc, 
  updateDoc, 
  collection, 
  query, 
  where, 
  orderBy, 
  onSnapshot, 
  getDocs 
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";

const firebaseConfig = {
apiKey:"AIzaSyCbhjiiQ8ej5yu6LqLPb57XwrFlubFZyvA",
authDomain:"becomingsoft-84e72.firebaseapp.com",
projectId:"becomingsoft-84e72",
storageBucket:"becomingsoft-84e72.firebasestorage.app",
messagingSenderId:"605759003962",
appId:"1:605759003962:web:ea8603a8e97e42d2278403"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);
const storage=getStorage(app);

const avatar=document.getElementById("avatar");
const avatarInput=document.getElementById("avatarInput");
const alias=document.getElementById("alias");
const followersBtn=document.getElementById("followersBtn");
const followingBtn=document.getElementById("followingBtn");
const spotifyEmbed=document.getElementById("spotifyEmbed");
const spotifyInput=document.getElementById("spotifyInput");
const saveSpotifyBtn=document.getElementById("saveSpotifyBtn");
const logoutBtn=document.getElementById("logoutBtn");
const searchBtn=document.getElementById("searchBtn");
const searchInput=document.getElementById("searchInput");
const photoInput=document.getElementById("photoInput");
const reorderBtn=document.getElementById("reorderBtn");
const photoEls=["p1","p2","p3","p4","p5","p6"].map(id=>document.getElementById(id));
const copyBtn=document.getElementById("copyBtn");
const copyMessage=document.getElementById("copyMessage");
/* =========================
   NOTIFICATIONS DOM
========================= */

const notifBtn = document.getElementById("notifBtn");
const notifDropdown = document.getElementById("notifDropdown");
const notifDot = document.getElementById("notifDot");
const notifList = document.getElementById("notifList");

let uid=null;
let photoIndex=0;

/* =========================
   REORDER SYSTEM
========================= */

let reorderMode=false;
let draggedEl=null;

function enableDrag(){
  document.querySelector(".container").classList.add("reorder-active");
  photoEls.forEach(el=>{
    el.setAttribute("draggable",true);
    el.addEventListener("dragstart",handleDragStart);
    el.addEventListener("dragover",handleDragOver);
    el.addEventListener("drop",handleDrop);
  });
}

function disableDrag(){
  document.querySelector(".container").classList.remove("reorder-active");
  photoEls.forEach(el=>{
    el.setAttribute("draggable",false);
    el.removeEventListener("dragstart",handleDragStart);
    el.removeEventListener("dragover",handleDragOver);
    el.removeEventListener("drop",handleDrop);
  });
}

function handleDragStart(e){
  draggedEl=this;
}

function handleDragOver(e){
  e.preventDefault();
}

function handleDrop(e){
  e.preventDefault();
  if(draggedEl!==this){
    const parent=this.parentNode;
    const children=Array.from(parent.children);
    const draggedIndex=children.indexOf(draggedEl);
    const targetIndex=children.indexOf(this);
    if(draggedIndex<targetIndex){
      parent.insertBefore(draggedEl,this.nextSibling);
    }else{
      parent.insertBefore(draggedEl,this);
    }
  }
}

reorderBtn.addEventListener("click",async()=>{
  reorderMode=!reorderMode;
  if(reorderMode){
    reorderBtn.textContent="Guardar orden";
    enableDrag();
  }else{
    reorderBtn.textContent="Reordenar fotos";
    const isMobile=window.innerWidth<=700;
    const photosContainer = document.querySelector(".photos");
const newOrder = Array.from(photosContainer.children).map(img => img.src || "");
    if(isMobile){
      await updateDoc(doc(db,"users",uid),{photosMobile:newOrder});
    }else{
      await updateDoc(doc(db,"users",uid),{photosDesktop:newOrder});
    }
    disableDrag();
  }
});

/* =========================
   AUTH + LOAD PROFILE
========================= */

onAuthStateChanged(auth,async(user)=>{
if(!user){location.href="login.html";return;}
uid=user.uid;
/* =========================
   LISTEN NOTIFICATIONS
========================= */

/* =========================
   LISTEN NOTIFICATIONS
========================= */

const q = query(
  collection(db,"notifications"),
  where("toUserId","==",uid),
  orderBy("createdAt","desc")
);

onSnapshot(q,(snapshot)=>{
  notifList.innerHTML="";
  let unread = 0;

  snapshot.forEach(docSnap=>{
    const data = docSnap.data();

    if(!data.read) unread++;

    const div = document.createElement("div");
    div.className = "notif-item";
    div.style.cursor = "pointer";

    if(data.type==="follow"){
      div.textContent = `${data.fromUsername} started following you`;
      div.addEventListener("click",()=>{
        location.href = `user.html?alias=${data.fromUsername}`;
      });
    }

    else if(data.type==="like"){

  div.innerHTML = "";

  let fromAlias = "alguien";
  let messagePreview = "...";

  if(data.messagePreview){
    messagePreview = data.messagePreview.slice(0,30);
  }

  // obtener alias real desde users usando fromUid
  getDoc(doc(db,"users",data.fromUid)).then(userSnap=>{

    if(userSnap.exists()){
      fromAlias = userSnap.data().alias || "alguien";
    }

    const userSpan = document.createElement("span");
    userSpan.textContent = fromAlias;
    userSpan.style.fontWeight = "600";
    userSpan.style.cursor = "pointer";

    userSpan.addEventListener("click",(e)=>{
      e.stopPropagation();
      location.href = `user.html?alias=${fromAlias}`;
    });

    const textSpan = document.createElement("span");
    textSpan.textContent = ` le dio like a: "${messagePreview}"`;

    div.appendChild(userSpan);
    div.appendChild(textSpan);

  });

  div.addEventListener("click",()=>{
    location.href = `wall.html?uid=${data.toUserId}&highlight=${data.messageId}`;
  });

}

    else if(data.type==="message"){
      div.textContent = `${data.fromUsername} sent you a message`;
      div.addEventListener("click",()=>{
        location.href = `inbox.html?alias=${data.fromUsername}`;
      });
    }
    
    else if(data.type==="reply"){
  div.textContent = `${data.fromUsername} respondi√≥ tu mensaje`;
  div.addEventListener("click",()=>{
    location.href = "feed.html";
  });
}

    else{
      div.textContent = "new activity";
    }

    notifList.appendChild(div);
  });

  notifDot.style.display = unread > 0 ? "block" : "none";
});

const wallBtn=document.getElementById("wallBtn");
wallBtn.onclick=()=>location.href=`wall.html?uid=${uid}`;

const snap=await getDoc(doc(db,"users",uid));
const d=snap.data();
const profileLink=`https://becomingsoft.com/${d.alias}`;
document.getElementById("profileLink").value=profileLink;

/* LIMPIEZA FOLLOWERS FANTASMAS */
let validFollowers=[];
for(const fid of (d.followers||[])){
  const exists=await getDoc(doc(db,"users",fid));
  if(exists.exists()) validFollowers.push(fid);
}

let validFollowing=[];
for(const fid of (d.following||[])){
  const exists=await getDoc(doc(db,"users",fid));
  if(exists.exists()) validFollowing.push(fid);
}

if(validFollowers.length!==(d.followers||[]).length ||
   validFollowing.length!==(d.following||[]).length){
  await updateDoc(doc(db,"users",uid),{
    followers:validFollowers,
    following:validFollowing
  });
}

alias.textContent=d.alias||"sin alias";
followersBtn.textContent=`${validFollowers.length} followers`;
followingBtn.textContent=`${validFollowing.length} following`;

followersBtn.onclick=()=>location.href=`list.html?uid=${uid}&type=followers`;
followingBtn.onclick=()=>location.href=`list.html?uid=${uid}&type=following`;

if(d.photoURL) avatar.src=d.photoURL;

const isMobile=window.innerWidth<=700;
let desktopArray=d.photosDesktop||d.photos||["","","","","",""];
let mobileArray=d.photosMobile||d.photos||["","","","","",""];
let currentPhotos=isMobile?mobileArray:desktopArray;

currentPhotos.forEach((url,i)=>{
if(url) photoEls[i].src=url;
});

if(d.spotifyEmbed) spotifyEmbed.innerHTML=d.spotifyEmbed;

/* THEME */
if(d.theme){
document.body.style.backgroundColor=d.theme.pageBg||"#f5f5f5";
document.querySelector(".container").style.backgroundColor=d.theme.cardBg||"#ffffff";

if(d.theme.backgroundImage){
document.body.style.backgroundImage=`url(${d.theme.backgroundImage})`;
document.body.style.backgroundSize="cover";
document.body.style.backgroundPosition="center";
}else{
document.body.style.backgroundImage="none";
}
}
});

/* =========================
   PHOTO UPLOAD
========================= */

photoEls.forEach((el,i)=>{
el.addEventListener("click",()=>{
if(reorderMode) return;
photoIndex=i;
photoInput.click();
});
});

photoInput.addEventListener("change",async()=>{
const file=photoInput.files[0];
if(!file)return;

const storageRef=ref(storage,`spaces/${uid}/${photoIndex}`);
await uploadBytes(storageRef,file);
const url=await getDownloadURL(storageRef);

const snap=await getDoc(doc(db,"users",uid));
const data=snap.data();
const isMobile=window.innerWidth<=700;

let arrayToUpdate=isMobile
? (data.photosMobile||data.photos||["","","","","",""])
: (data.photosDesktop||data.photos||["","","","","",""]);

arrayToUpdate[photoIndex]=url;

await updateDoc(doc(db,"users",uid),
isMobile
? {photosMobile:arrayToUpdate}
: {photosDesktop:arrayToUpdate}
);

photoEls[photoIndex].src=url;
});

/* =========================
   AVATAR
========================= */

avatar.addEventListener("click",()=>avatarInput.click());
avatarInput.addEventListener("change",async()=>{
const file=avatarInput.files[0];
if(!file)return;
const storageRef=ref(storage,`avatars/${uid}`);
await uploadBytes(storageRef,file);
const url=await getDownloadURL(storageRef);
await updateDoc(doc(db,"users",uid),{photoURL:url});
avatar.src=url;
});

/* =========================
   SPOTIFY
========================= */

saveSpotifyBtn.addEventListener("click",async()=>{
const embed=spotifyInput.value.trim();
if(!embed)return;
await updateDoc(doc(db,"users",uid),{spotifyEmbed:embed});
spotifyEmbed.innerHTML=embed;
spotifyInput.value="";
});

/* =========================
   LOGOUT
========================= */

logoutBtn.addEventListener("click",async()=>{
await signOut(auth);
location.href="login.html";
});

/* =========================
   SEARCH
========================= */

searchBtn.addEventListener("click",()=>{
const value=searchInput.value.trim();
if(!value)return;
location.href=`user.html?alias=${value}`;
});

searchInput.addEventListener("keydown",(e)=>{
if(e.key==="Enter"){
const value=searchInput.value.trim();
if(!value)return;
location.href=`user.html?alias=${value}`;
}
});

/* =========================
   COPY LINK
========================= */

copyBtn.addEventListener("click",()=>{
const input=document.getElementById("profileLink");
if(!input||!input.value)return;

navigator.clipboard.writeText(input.value).then(()=>{
copyMessage.textContent="Copied ‚ú®";
setTimeout(()=>copyMessage.textContent="",2000);
}).catch(()=>{
copyMessage.textContent="Couldn't copy";
setTimeout(()=>copyMessage.textContent="",2000);
});
});

/* =========================
   NOTIFICATION TOGGLE
========================= */

notifBtn.addEventListener("click",async()=>{
  const open = notifDropdown.style.display==="block";
  notifDropdown.style.display = open ? "none" : "block";

  if(!open && uid){
    const unreadQuery=query(
      collection(db,"notifications"),
      where("toUserId","==",uid),
      where("read","==",false)
    );

    const snap=await getDocs(unreadQuery);
    snap.forEach(docSnap=>{
      updateDoc(doc(db,"notifications",docSnap.id),{read:true});
    });
  }
});

document.addEventListener("click",(e)=>{
  if(!e.target.closest(".notif-wrapper")){
    notifDropdown.style.display="none";
  }
});
</script>

</body>
</html>