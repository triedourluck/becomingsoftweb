<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>becomingsoft — mi perfil</title>

<style>
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#f5f5f5;color:#111;}

.container{
  max-width:900px;
  margin:40px auto;
  background:white;
  border-radius:20px;
  padding:32px;
  box-shadow:0 10px 30px rgba(0,0,0,0.08);
  position:relative;
}

/* SEARCH DESKTOP */
.search{position:absolute;top:20px;right:24px;display:flex;gap:8px;}
.search input{width:190px;padding:10px 12px;border-radius:12px;border:1px solid #ddd;font-size:14px;}
.search button{padding:10px 16px;border:none;border-radius:12px;background:#111;color:white;cursor:pointer;font-size:14px;}

.logout{position:absolute;top:64px;right:24px;padding:8px 14px;border:none;border-radius:10px;background:#111;color:white;cursor:pointer;font-size:13px;}

.top{display:flex;gap:20px;align-items:center;margin-top:10px;}
.avatar{width:80px;height:80px;border-radius:50%;background:#ddd;object-fit:cover;cursor:pointer;}
.alias{font-size:20px;font-weight:600;}

.stats{font-size:13px;color:#666;margin-top:6px;}
.stats span{cursor:pointer;}

.layout{display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-top:24px;align-items:start;}

.photos{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;}
.photo{width:100%;height:140px;background:#eee;border-radius:12px;object-fit:cover;cursor:pointer;}

.right{display:flex;flex-direction:column;gap:20px;}

.spotify{margin-top:40px;width:100%;}
.spotify iframe{width:100%;border:none;border-radius:12px;display:block;}
.spotify input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #ddd;margin-top:14px;box-sizing:border-box;}

.save-btn{margin-top:8px;padding:6px 12px;border:none;border-radius:8px;background:#111;color:white;cursor:pointer;font-size:12px;}

.bottom{margin-top:24px;display:flex;gap:12px;}
.gear,.icon-btn{padding:10px 14px;border:none;border-radius:10px;background:#111;color:white;cursor:pointer;font-size:14px;}

.hidden{display:none;}

/* MOBILE */
@media (max-width:700px){
.container{margin:0;border-radius:0;padding:20px 18px 90px;}
.search{position:absolute;top:14px;right:16px;}
.search input{width:130px;padding:6px 8px;font-size:12px;}
.search button{padding:6px 10px;font-size:12px;}
.logout{top:54px;right:16px;font-size:12px;padding:6px 10px;}
.top{margin-top:80px;gap:12px;}
.avatar{width:64px;height:64px;}
.alias{font-size:18px;}
.stats{font-size:12px;margin-top:4px;}
.layout{display:block;margin-top:20px;}
.photos{grid-template-columns:repeat(3,1fr);gap:10px;}
.photo{height:100px;}
.bottom{position:fixed;bottom:18px;left:0;width:100%;justify-content:center;}
}
</style>
</head>

<body>
<div class="container">

<div class="search">
<input id="searchInput" placeholder="buscar usuario"/>
<button id="searchBtn">ir</button>
</div>

<button class="logout" id="logoutBtn">Cerrar sesión</button>

<div class="top">
<img id="avatar" class="avatar"/>
<input type="file" id="avatarInput" class="hidden" accept="image/*"/>
<div>
<div class="alias" id="alias">...</div>
<div class="stats">
<span id="followersBtn">0 followers</span> ·
<span id="followingBtn">0 following</span>
</div>
</div>
</div>

<div class="layout">
<div>
<div class="photos">
<img id="p1" class="photo"/>
<img id="p2" class="photo"/>
<img id="p3" class="photo"/>
<img id="p4" class="photo"/>
<img id="p5" class="photo"/>
<img id="p6" class="photo"/>
</div>
<input type="file" id="photoInput" class="hidden" accept="image/*"/>
</div>

<div class="right">
<div class="spotify">
<div id="spotifyEmbed"></div>
<input id="spotifyInput" placeholder="Pega aquí el embed de Spotify"/>
<button class="save-btn" id="saveSpotifyBtn">Guardar playlist</button>
</div>
</div>
</div>

<div class="bottom">
<button class="gear" onclick="location.href='settings.html'">⚙️</button>
<button class="icon-btn" onclick="location.href='feed.html'">Feed</button>
<button class="icon-btn" onclick="location.href='inbox.html'">✉️</button>
<button class="icon-btn" onclick="location.href='wall.html'">SHHH!</button>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";

const firebaseConfig={
apiKey:"AIzaSyCbhjiiQ8ej5yu6LqLPb57XwrFlubFZyvA",
authDomain:"becomingsoft-84e72.firebaseapp.com",
projectId:"becomingsoft-84e72",
storageBucket:"becomingsoft-84e72.firebasestorage.app",
messagingSenderId:"605759003962",
appId:"1:605759003962:web:ea8603a8e97e42d2278403"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);
const storage=getStorage(app);

const avatar=document.getElementById("avatar");
const avatarInput=document.getElementById("avatarInput");
const alias=document.getElementById("alias");
const followersBtn=document.getElementById("followersBtn");
const followingBtn=document.getElementById("followingBtn");
const spotifyEmbed=document.getElementById("spotifyEmbed");
const spotifyInput=document.getElementById("spotifyInput");
const saveSpotifyBtn=document.getElementById("saveSpotifyBtn");
const logoutBtn=document.getElementById("logoutBtn");
const searchBtn=document.getElementById("searchBtn");
const searchInput=document.getElementById("searchInput");
const photoInput=document.getElementById("photoInput");
const photoEls=["p1","p2","p3","p4","p5","p6"].map(id=>document.getElementById(id));

let uid=null;
let photoIndex=0;

onAuthStateChanged(auth,async(user)=>{
if(!user){location.href="login.html";return;}
uid=user.uid;

const snap=await getDoc(doc(db,"users",uid));
const d=snap.data();

alias.textContent=d.alias||"sin alias";

/* FILTRAR FOLLOWERS */
let validFollowers=[];
if(d.followers){
for(const f of d.followers){
const s=await getDoc(doc(db,"users",f));
if(s.exists()) validFollowers.push(f);
}
}

/* FILTRAR FOLLOWING */
let validFollowing=[];
if(d.following){
for(const f of d.following){
const s=await getDoc(doc(db,"users",f));
if(s.exists()) validFollowing.push(f);
}
}

followersBtn.textContent=`${validFollowers.length} followers`;
followingBtn.textContent=`${validFollowing.length} following`;

followersBtn.onclick=()=>location.href=`list.html?uid=${uid}&type=followers`;
followingBtn.onclick=()=>location.href=`list.html?uid=${uid}&type=following`;

/* DEVICE DETECTION */
const isMobile=window.innerWidth<=700;

let photosDesktop=d.photosDesktop||d.photos||["","","","","",""];
let photosMobile=d.photosMobile||d.photos||["","","","","",""];

if(!d.photosDesktop||!d.photosMobile){
await updateDoc(doc(db,"users",uid),{
photosDesktop:photosDesktop,
photosMobile:photosMobile
});
}

let currentPhotos=isMobile?photosMobile:photosDesktop;

currentPhotos.forEach((url,i)=>{
if(url) photoEls[i].src=url;
});

/* THEME */
if(d.theme){
document.body.style.backgroundColor=d.theme.pageBg||"#f5f5f5";
document.querySelector(".container").style.backgroundColor=d.theme.cardBg||"#ffffff";
if(d.theme.backgroundImage){
document.body.style.backgroundImage=`url(${d.theme.backgroundImage})`;
document.body.style.backgroundSize="cover";
document.body.style.backgroundPosition="center";
}else{
document.body.style.backgroundImage="none";
}
}

/* MOBILE DRAG SWAP */
if(isMobile){
let startIndex=null;

photoEls.forEach((el,i)=>{
el.addEventListener("touchstart",()=>{startIndex=i;});

el.addEventListener("touchend",async(e)=>{
const touch=e.changedTouches[0];
const target=document.elementFromPoint(touch.clientX,touch.clientY);
const endIndex=photoEls.findIndex(img=>img===target);

if(startIndex===null||endIndex===-1||startIndex===endIndex)return;

const snap2=await getDoc(doc(db,"users",uid));
let data2=snap2.data();
let mobileArray=data2.photosMobile||data2.photos||[];

[mobileArray[startIndex],mobileArray[endIndex]]=
[mobileArray[endIndex],mobileArray[startIndex]];

await updateDoc(doc(db,"users",uid),{photosMobile:mobileArray});

mobileArray.forEach((url,i)=>{photoEls[i].src=url;});

startIndex=null;
});
});
}

});

/* AVATAR */
avatar.addEventListener("click",()=>avatarInput.click());
avatarInput.addEventListener("change",async()=>{
const file=avatarInput.files[0];
if(!file)return;
const storageRef=ref(storage,`avatars/${uid}`);
await uploadBytes(storageRef,file);
const url=await getDownloadURL(storageRef);
await updateDoc(doc(db,"users",uid),{photoURL:url});
avatar.src=url;
});

/* GRID UPLOAD (DESKTOP ONLY) */
photoEls.forEach((el,i)=>{
el.addEventListener("click",()=>{
if(window.innerWidth<=700)return;
photoIndex=i;
photoInput.click();
});
});

photoInput.addEventListener("change",async()=>{
const file=photoInput.files[0];
if(!file)return;
const storageRef=ref(storage,`spaces/${uid}/${photoIndex}`);
await uploadBytes(storageRef,file);
const url=await getDownloadURL(storageRef);

const snap=await getDoc(doc(db,"users",uid));
const data=snap.data();
let desktopArray=data.photosDesktop||data.photos||["","","","","",""];
desktopArray[photoIndex]=url;

await updateDoc(doc(db,"users",uid),{photosDesktop:desktopArray});
photoEls[photoIndex].src=url;
});

/* SPOTIFY */
saveSpotifyBtn.addEventListener("click",async()=>{
const embed=spotifyInput.value.trim();
if(!embed)return;
await updateDoc(doc(db,"users",uid),{spotifyEmbed:embed});
spotifyEmbed.innerHTML=embed;
spotifyInput.value="";
});

/* LOGOUT */
logoutBtn.addEventListener("click",async()=>{
await signOut(auth);
location.href="login.html";
});

/* SEARCH */
searchBtn.addEventListener("click",()=>{
const value=searchInput.value.trim();
if(!value)return;
location.href=`user.html?alias=${value}`;
});
</script>

</body>
</html>